# Codebase Structure Documentation

This document provides a comprehensive overview of the NixOS configuration repository structure, intended to help AI agents and developers understand the codebase organization.

## Repository Overview

This is a NixOS flake-based configuration repository managing multiple hosts (laptop and desktop) with shared dotfiles managed via GNU Stow. The configuration uses Home Manager for user-specific settings and follows a modular structure.

## Root Directory Structure

```
/home/iva/nix/
├── flake.nix              # Main flake definition with inputs and host configurations
├── flake.lock             # Locked dependency versions
├── README.md              # Quick reference for common commands
├── AGENTS.md              # Repository guidelines and conventions
├── Agents.md              # This file - codebase structure documentation
├── hosts/                 # Host-specific configurations
└── dotfiles/              # User dotfiles managed by GNU Stow
```

## Core Files

### `flake.nix`

The root flake file that:
- Defines all flake inputs (nixpkgs, home-manager, zen-browser, nixos-hardware, winapps, ayugram-desktop)
- Maps host configurations via `hostConfigs` attribute set
- Uses `mkHost` function to build NixOS configurations for each host
- Sets up Home Manager integration for user `iva`
- Configures global overlays and system packages (e.g., code-cursor, winapps)
- Exports `nixosConfigurations` for each host

**Key Structure:**
- `hostConfigs`: Maps host names to their configuration paths
  - `laptop`: Uses `./hosts/laptop/configuration.nix` and `./hosts/laptop/gnome.nix`
  - `legion`: Uses `./hosts/legion/configuration.nix` and `./hosts/legion/gnome.nix`, includes Lenovo Legion hardware module
- `mkHost`: Function that builds a complete NixOS system configuration from host configs

### `README.md`

Contains quick reference commands for:
- Stowing dotfiles: `cd nix/dotfiles/ && stow -t $HOME */`

### `AGENTS.md`

Repository guidelines covering:
- Project structure and module organization
- Build, test, and development commands
- Coding style and naming conventions
- Testing guidelines
- Commit and pull request guidelines
- Package search commands

## Hosts Directory (`hosts/`)

Each host has its own subdirectory containing:
- `configuration.nix`: Main NixOS system configuration
- `hardware-configuration.nix`: Hardware-specific settings (generated by `nixos-generate-config`)
- `gnome.nix`: Home Manager configuration for GNOME desktop settings
- Additional host-specific assets (e.g., wallpapers, secrets)

### `hosts/laptop/`

Laptop-specific configuration:
- **configuration.nix**: System configuration with:
  - Bootloader (systemd-boot)
  - Networking (NetworkManager)
  - GNOME desktop environment
  - PipeWire audio
  - System packages (emacs, vscode, zed-editor, etc.)
  - User account (`iva`) with zsh shell
  - Services (n8n)
- **gnome.nix**: Home Manager config with:
  - GNOME dconf settings (theme, keybindings, night light, etc.)
  - Custom keybindings (Super+e for Emacs, Super+z for Zen Browser, etc.)
  - Zed editor configuration symlinks
  - Custom scripts (toggle-night-light)

### `hosts/legion/`

Desktop (Lenovo Legion) configuration with additional features:
- **configuration.nix**: Extended system configuration with:
  - Lenovo Legion-specific kernel modules and parameters
  - NVIDIA/AMD hybrid graphics setup (Prime offload)
  - Additional packages (blender, davinci-resolve, virt-manager, etc.)
  - TLP power management
  - Battery conservation mode configuration
  - Firewall rules for P2P connections
  - Wayland portal configuration
  - Custom scripts (davinci-nvidia, lenovo-conservation)
- **gnome.nix**: Similar to laptop but may have desktop-specific tweaks
- **backgrounds/**: Host-specific wallpaper assets
  - `wallpaper.jpg`

## Dotfiles Directory (`dotfiles/`)

User dotfiles organized by tool, intended for GNU Stow management. Each subdirectory mirrors the target location structure.

### Structure

```
dotfiles/
├── easyeffects/          # EasyEffects parametric EQ presets
│   └── Koss KSC75 ParametricEq.txt
├── emacs/                # Emacs configuration
│   └── .emacs.d/
│       └── init.org      # Main Emacs config (edit this, not init.el)
├── ghostty/              # Ghostty terminal configuration
├── git/                  # Git configuration files
├── gnome/                # GNOME-specific dotfiles (if any)
├── vscode/               # VS Code settings
├── zed/                  # Zed editor configuration
│   ├── keymap.json
│   └── settings.json
└── zsh/                  # Zsh configuration files
```

### Dotfiles Management

- **Stow Command**: `cd nix/dotfiles/ && stow -t $HOME */`
- Each directory under `dotfiles/` should mirror the target filesystem structure
- Example: `dotfiles/vscode/.config/Code/User/settings.json` becomes `~/.config/Code/User/settings.json` after stowing

### Special Cases

- **Emacs**: Always edit `dotfiles/emacs/.emacs.d/init.org`, not `init.el` (which is generated)
- **Zed**: Configuration is symlinked from Home Manager (`hosts/*/gnome.nix`) rather than stowed

## Configuration Flow

1. **System Configuration**: `flake.nix` → `hosts/<name>/configuration.nix` → `hosts/<name>/hardware-configuration.nix`
2. **User Configuration**: `flake.nix` → `hosts/<name>/gnome.nix` (Home Manager)
3. **Dotfiles**: Managed separately via GNU Stow from `dotfiles/` directory

## Build and Deployment

### Flake Commands

- `nix flake check`: Lint and validate the flake
- `nixos-rebuild --flake .#laptop test`: Build and test laptop configuration (no bootloader changes)
- `nixos-rebuild --flake .#laptop switch`: Full rebuild and activation with bootloader update
- `nixos-rebuild --flake .#legion test`: Build and test legion configuration
- `nixos-rebuild --flake .#legion switch`: Full rebuild and activation for legion

### Dotfiles Deployment

```bash
cd /home/iva/nix/dotfiles/
stow -t $HOME <package-name>  # Stow specific package
stow -t $HOME */              # Stow all packages
```

## Key Dependencies

### Flake Inputs

- `nixpkgs`: Main package repository (unstable)
- `nixpkgs-stable`: Stable package repository (24.11) for packages that fail on unstable
- `home-manager`: User environment management
- `zen-browser`: Zen Browser flake
- `nixos-hardware`: Hardware-specific modules (Lenovo Legion)
- `winapps`: Windows app integration
- `ayugram-desktop`: Ayugram desktop client

### Global System Packages

Configured in `flake.nix`:
- `code-cursor`: Cursor editor
- `winapps`: Windows app launcher

### Common Host Packages

Both hosts share many packages:
- Development: git, gh, emacs, vscode, zed-editor, codex, starship, zoxide
- System: stow, tree, bat, ripgrep, fd, nix-search-cli, nixd
- Desktop: bitwarden-desktop, easyeffects, obs-studio, gnome-tweaks
- Fonts: maple-mono.NF, apple-cursor

### Legion-Specific Packages

Additional packages for the desktop:
- Media: blender, davinci-resolve, ffmpeg, audacity, orca-slicer
- Virtualization: virt-manager, qemu, OVMF
- Messaging: ayugram-desktop

## User Account

- **Username**: `iva`
- **Shell**: zsh
- **Groups**: networkmanager, wheel (both hosts); additional: input, kvm, libvirtd, docker (legion)
- **Home Directory**: `/home/iva`

## Important Notes

1. **Hardware Configurations**: `hardware-configuration.nix` files are typically generated by `nixos-generate-config` and should be committed to version control
2. **Secrets**: Keep sensitive data in `hosts/<name>/` directories, not in shared locations
3. **State Versions**: 
   - NixOS: `25.05` (both hosts)
   - Home Manager: `24.11` (laptop)
4. **Experimental Features**: Both hosts enable `nix-command` and `flakes`
5. **Kernel**: Both hosts use `linuxPackages_latest`

## File Relationships

```
flake.nix
  ├── hosts/laptop/
  │   ├── configuration.nix (imports hardware-configuration.nix)
  │   ├── hardware-configuration.nix
  │   └── gnome.nix (Home Manager config)
  └── hosts/legion/
      ├── configuration.nix (imports hardware-configuration.nix)
      ├── hardware-configuration.nix
      ├── gnome.nix (Home Manager config)
      └── backgrounds/wallpaper.jpg

dotfiles/ (managed separately via Stow)
  ├── emacs/.emacs.d/init.org
  ├── zed/settings.json (also symlinked via Home Manager)
  └── ... (other tool configs)
```

## Common Tasks

### Adding a New Package

1. Add to `environment.systemPackages` in `hosts/<name>/configuration.nix`
2. Run `nix flake check` to validate
3. Rebuild with `nixos-rebuild --flake .#<host> switch`

### Adding a New Host

1. Create `hosts/<new-host>/` directory
2. Add `configuration.nix`, `hardware-configuration.nix`, and `gnome.nix`
3. Add entry to `hostConfigs` in `flake.nix`
4. Rebuild and test

### Modifying GNOME Settings

1. Edit `hosts/<name>/gnome.nix`
2. Update `dconf.settings` as needed
3. Rebuild with `nixos-rebuild --flake .#<host> switch`

### Managing Dotfiles

1. Add/edit files in `dotfiles/<tool>/` following target filesystem structure
2. Run `stow -t $HOME <tool>` from `dotfiles/` directory
3. Commit changes to version control

